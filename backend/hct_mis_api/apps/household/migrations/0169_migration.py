# Generated by Django 3.2.23 on 2024-02-07 12:44
from django.core.paginator import Paginator
from django.db import migrations, models


def populate_individual_detail_id(apps, schema_editor):
    batch_size = 1000
    Individual = apps.get_model("household", "Individual")

    ind_qs_with_kobo_asset_id = Individual.objects.exclude(kobo_asset_id="")
    ind_qs_with_row_id = Individual.objects.exclude(row_id__isnull=True)

    paginator = Paginator(ind_qs_with_kobo_asset_id.order_by("id"), batch_size)
    for page_n in paginator.page_range:
        ind_list = []
        for individual in paginator.page(page_n).object_list:
            individual.detail_id = individual.kobo_asset_id
            ind_list.append(individual)
        Individual.objects.bulk_update(ind_list, ["detail_id"])

    paginator = Paginator(ind_qs_with_row_id.order_by("id"), batch_size)
    for page_n in paginator.page_range:
        ind_list = []
        for individual in paginator.page(page_n).object_list:
            individual.detail_id = individual.row_id
            ind_list.append(individual)
        Individual.objects.bulk_update(ind_list, ["detail_id"])




class Migration(migrations.Migration):

    dependencies = [
        ('household', '0168_migration'),
    ]

    operations = [
        migrations.AddField(
            model_name='individual',
            name='detail_id',
            field=models.CharField(blank=True, help_text='Kobo asset ID, Xlsx row ID, Aurora source ID', max_length=150, null=True),
        ),
        migrations.RunPython(populate_individual_detail_id, migrations.RunPython.noop),
    ]
